services:
  setup:
    image: node:20
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - ADDITIONAL_OVERLAYS=${ADDITIONAL_OVERLAYS}
    command: ./bin/docker-setup

  traefik:
    image: traefik:v3.1
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--entrypoints.web.address=:80"
    ports:
      - "${TRAEFIK_PORT:-13100}:80"
      - "${TRAEFIK_DASHBOARD_PORT:-13180}:8080" # Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  web:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_SSO_URL: "http://sso.${DOMAIN:-mdtutor.3oe.de}"
        VITE_COMMIT_HASH: "${COMMIT_HASH:-unknown}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`${DOMAIN:-mdtutor.3oe.de}`)"
      - "traefik.http.routers.web.entrypoints=web"

  api-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: packages/api-server/Dockerfile
      args:
        COMMIT_HASH: "${COMMIT_HASH:-unknown}"
    environment:
      - API_PORT=3101
    volumes:
      - ./content:/app/content
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${DOMAIN:-mdtutor.3oe.de}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.priority=10"
      - "traefik.http.services.api.loadbalancer.server.port=3101"

  achievement-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: packages/backend-ruby
    command: >
      bash -c "./bin/rails db:prepare db:seed && ./bin/rails server"
    environment:
      - RAILS_ENV=production
      - RAILS_MASTER_KEY=${ACHIEVEMENTS_MASTER_KEY}
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true
      - SSO_JWT_SECRET=${SSO_JWT_SECRET}
    volumes:
      - achievement_data:/rails/db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.achievements.rule=Host(`${DOMAIN:-mdtutor.3oe.de}`) && (PathPrefix(`/api/v1/actions`) || PathPrefix(`/api/v1/auth`))"
      - "traefik.http.routers.achievements.entrypoints=web"
      - "traefik.http.routers.achievements.priority=20"
      - "traefik.http.services.achievements.loadbalancer.server.port=3000"

  sso-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: packages/sso-server
    command: >
      bash -c "./bin/rails db:prepare db:seed && ./bin/rails server"
    environment:
      - RAILS_ENV=production
      - RAILS_MASTER_KEY=${SSO_MASTER_KEY}
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true
      - SSO_JWT_SECRET=${SSO_JWT_SECRET}
      - ACHIEVEMENTS_PORT=3000 # Internal port of achievement-server
      - ACHIEVEMENTS_URL=http://achievement-server:3000
    volumes:
      - sso_data:/rails/db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sso.rule=Host(`sso.${DOMAIN:-mdtutor.3oe.de}`)"
      - "traefik.http.routers.sso.entrypoints=web"
      - "traefik.http.services.sso.loadbalancer.server.port=3000"

volumes:
  achievement_data:
  sso_data:

