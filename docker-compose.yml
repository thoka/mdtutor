services:
  setup:
    image: node:20
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - ADDITIONAL_OVERLAYS=${ADDITIONAL_OVERLAYS}
    command: ./bin/docker-setup

  traefik:
    image: traefik:v2.11
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # ACME / Let's Encrypt setup
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL:-info@3oe.de}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
    ports:
      - "${TRAEFIK_PORT:-13100}:80"
      - "${TRAEFIK_HTTPS_PORT:-13443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-13180}:8080" # Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik_certs:/letsencrypt"
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  web:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_SSO_URL: "${WEB_PROTOCOL:-http}://sso.${DOMAIN:-mdtutor.localhost}${TRAEFIK_PORT_SUFFIX:-}"
        VITE_COMMIT_HASH: "${COMMIT_HASH:-unknown}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`${DOMAIN:-mdtutor.localhost}`)"
      - "traefik.http.routers.web.entrypoints=web,websecure"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.routers.web.tls=${HTTPS_ENABLED:-false}"
      - "traefik.http.routers.web.tls.certresolver=myresolver"
      - "traefik.http.routers.web.middlewares=${HTTPS_REDIRECT:-}"

  api-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: .
      dockerfile: packages/api-server/Dockerfile
      args:
        COMMIT_HASH: "${COMMIT_HASH:-unknown}"
    environment:
      - API_PORT=3101
    volumes:
      - ./content:/app/content
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${DOMAIN:-mdtutor.localhost}`) && (PathPrefix(`/api`) || PathPrefix(`/content`))"
      - "traefik.http.routers.api.entrypoints=web,websecure"
      - "traefik.http.routers.api.tls=${HTTPS_ENABLED:-false}"
      - "traefik.http.routers.api.tls.certresolver=myresolver"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.routers.api.middlewares=${HTTPS_REDIRECT:-}"
      - "traefik.http.services.api.loadbalancer.server.port=3101"

  achievement-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: packages/backend-ruby
    command: >
      bash -c "./bin/rails db:prepare db:seed && ./bin/rails server"
    environment:
      - RAILS_ENV=production
      - RAILS_MASTER_KEY=${ACHIEVEMENTS_MASTER_KEY}
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true
      - RAILS_FORCE_SSL=${RAILS_FORCE_SSL:-false}
      - SSO_JWT_SECRET=${SSO_JWT_SECRET}
    volumes:
      - achievement_data:/rails/db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.achievements.rule=Host(`${DOMAIN:-mdtutor.localhost}`) && (PathPrefix(`/api/v1/actions`) || PathPrefix(`/api/v1/auth`))"
      - "traefik.http.routers.achievements.entrypoints=web,websecure"
      - "traefik.http.routers.achievements.tls=${HTTPS_ENABLED:-false}"
      - "traefik.http.routers.achievements.tls.certresolver=myresolver"
      - "traefik.http.routers.achievements.priority=200"
      - "traefik.http.routers.achievements.service=achievements"
      - "traefik.http.routers.achievements.middlewares=${HTTPS_REDIRECT:-}"
      - "traefik.http.services.achievements.loadbalancer.server.port=3000"

  sso-server:
    depends_on:
      setup:
        condition: service_completed_successfully
    build:
      context: packages/sso-server
    command: >
      bash -c "./bin/rails db:prepare db:seed && ./bin/rails server"
    environment:
      - RAILS_ENV=production
      - RAILS_MASTER_KEY=${SSO_MASTER_KEY}
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true
      - RAILS_FORCE_SSL=${RAILS_FORCE_SSL:-false}
      - SSO_JWT_SECRET=${SSO_JWT_SECRET}
      - ACHIEVEMENTS_PORT=3000 # Internal port of achievement-server
      - ACHIEVEMENTS_URL=http://achievement-server:3000
    volumes:
      - sso_data:/rails/db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sso.rule=Host(`sso.${DOMAIN:-mdtutor.localhost}`)"
      - "traefik.http.routers.sso.entrypoints=web,websecure"
      - "traefik.http.routers.sso.priority=100"
      - "traefik.http.routers.sso.service=sso"
      - "traefik.http.routers.sso.tls=${HTTPS_ENABLED:-false}"
      - "traefik.http.routers.sso.tls.certresolver=myresolver"
      - "traefik.http.routers.sso.middlewares=${HTTPS_REDIRECT:-}"
      - "traefik.http.services.sso.loadbalancer.server.port=3000"

volumes:
  achievement_data:
  sso_data:
  traefik_certs:

