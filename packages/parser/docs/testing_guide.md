# Parser Testing Guide

This guide explains the testing infrastructure for the MDTutor parser and how to achieve HTML parity with the original API.

## Snapshot-Based Parity Testing

The primary way we ensure the parser is working correctly is by comparing its output against "snapshots" of the original Raspberry Pi Learning API.

### Key Files

- `test/snapshots/`: Contains the original API JSON files and the corresponding Markdown repositories.
- `packages/parser/test/step-content-exact.test.js`: The main test suite that performs a deep structural comparison of all steps.
- `test-differences.json`: A detailed report generated by the parity test, listing every mismatch found.

## How to Run Targeted Tests

To speed up development, you can filter the parity tests by project and language using environment variables:

```bash
# Test only Silly Eyes in German
PROJECT=silly-eyes LANG=de-DE node --test packages/parser/test/step-content-exact.test.js

# Test only Silly Eyes in all available languages
PROJECT=silly-eyes node --test packages/parser/test/step-content-exact.test.js
```

## Interpreting `test-differences.json`

The `test-differences.json` file contains a list of mismatches. Each mismatch includes:

- `path`: The JSON path to the field (e.g., `steps[0].content`).
- `type`: The type of mismatch (e.g., `html_content_mismatch`).
- `htmlAnalysis`: A detailed breakdown of structural differences:
    - `expectedStructure`: The hierarchical tree of the original API HTML.
    - `actualStructure`: The hierarchical tree of our parser's output.
    - `structuralDifferences`: Specific tag, class, ID, or text mismatches.
    - `lineBasedDiff`: A unified diff of the raw HTML strings.

## Common Parity Issues

1. **Missing Wrappers**: Often, the original API wraps certain sections in `div.u-no-print` or `div.c-project-task`. Our parser must replicate these exactly.
2. **Attribute Differences**: Differences in `src` (absolute vs. relative) or `href` attributes.
3. **Whitespace/Formatting**: While the structural comparison ignores most whitespace, raw string differences may still appear in the `lineBasedDiff`.

## Workflow for Fixing Mismatches

1. Run the targeted test for a project.
2. Inspect `test-differences.json` to identify the first structural mismatch.
3. Modify the parser pipeline in `packages/parser/src/` (e.g., adding a plugin or adjusting `rehype` settings).
4. Re-run the test to verify the fix.
5. Repeat until `test-differences.json` shows no more differences for that project.
