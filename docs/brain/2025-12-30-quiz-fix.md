# Quiz Fix - Implementation Plan

**Date:** 2025-12-30  
**Branch:** `feature/fix-quiz`  
**Status:** In Progress

## Problem

Quiz funktioniert nicht mehr. Tests schlagen fehl mit:
1. "Assignment to constant variable" Fehler
2. "Cannot read properties of undefined (reading 'length')" in micromark

## Root Causes Identified

1. **parseFeedback returns wrong type**: `parseTutorial` returns `{ html, warnings }` but `parseFeedback` was returning the whole object instead of just `html`
2. **Duplicate const declaration**: In `parse-project.js`, `parts` was declared twice as `const` (lines 38 and 47)
3. **checked attribute**: Quiz radio buttons had `checked` attribute which violates spec (user must select answer)

## Fixes Applied

### 1. Fixed parseFeedback return value
**File:** `packages/parser/src/parse-quiz.js`
- Changed to extract `html` from `parseTutorial` result
- Added fallback: `return result.html || result;`
- **Reason:** `parseTutorial` now returns `{ html, warnings }` instead of just `html`

### 2. Fixed parseQuestion return value
**File:** `packages/parser/src/parse-question.js`
- Changed to extract `html` from `parseTutorial` result
- Added fallback: `const questionHtml = questionResult.html || questionResult;`
- **Reason:** Same as above - `parseTutorial` API changed

### 3. Fixed duplicate const declaration
**File:** `packages/parser/src/parse-project.js`
- Renamed first `parts` to `pathParts` (line 38)
- Kept second `parts` declaration (line 47) for basePath calculation

### 4. Removed checked attribute
**File:** `packages/parser/src/parse-quiz.js`
- Removed `checkedAttr` variable and `checked` attribute from radio inputs
- Per spec: user must select answer, no pre-selection

## Tests to Verify

- [ ] `parse-project-quiz-integration.test.js` - All 10 tests should pass
- [ ] `parse-quiz-detailed.test.js` - Quiz parsing tests
- [ ] `compare-quiz-api.test.js` - API comparison tests
- [ ] Manual test: Load quiz step in web app and verify interaction works

## Compatibility with Recent Markdown Parsing Changes

### Changes in parseTutorial API
- **Before:** `parseTutorial()` returned `string` (HTML)
- **After:** `parseTutorial()` returns `{ html, warnings }` object
- **Impact:** All callers need to extract `html` from result

### Block Delimiter Processing
- Block delimiters (`--- TYPE ---`) are now handled by micromark extension
- Quiz questions use delimiters: `--- question ---`, `--- choices ---`, `--- feedback ---`
- These are extracted via regex in `parse-question.js` BEFORE calling `parseTutorial`
- This is correct - quiz parsing needs to extract these blocks manually before markdown processing

### All Call Sites Updated
✅ `parse-project.js` - Already had fallback: `parseResult.html || parseResult`  
✅ `parse-question.js` - Fixed to extract `html` from result  
✅ `parse-quiz.js` (parseFeedback) - Fixed to extract `html` from result

## Next Steps

1. Run full test suite to verify fixes
2. If micromark error persists, investigate markdown parsing in quiz questions
3. Test quiz interaction in browser
4. Commit fixes with conventional commit message

## Related Files

- `packages/parser/src/parse-quiz.js` - Quiz parsing logic
- `packages/parser/src/parse-question.js` - Question parsing
- `packages/parser/src/parse-project.js` - Project parsing integration
- `apps/web/src/lib/StepContent.svelte` - Quiz rendering/interaction

