#!/bin/bash
set -e

echo "=== MDTutor Docker Setup ==="

# 0. Ensure node_modules exist
if [ ! -d "node_modules" ]; then
    echo "node_modules missing. Installing..."
    npm install
fi

# 1. Check if content directory exists
if [ ! -f "content/RPL/ecosystem.yaml" ]; then
    echo "ecosystem.yaml missing. Creating default..."
    cat > content/RPL/ecosystem.yaml <<EOF
name: Raspberry Pi Learning
namespace: RPL
parser_type: rpl-markdown
semantic_prefix: RPL
EOF
fi

if [ ! -d "content/RPL/layers/official/projects" ] || [ -z "$(ls -A content/RPL/layers/official/projects)" ]; then
    echo "Content missing or incomplete. Fetching RPL test data..."
    npm run sync:pathways
else
    echo "RPL content already exists."
fi

# 2. Run Structure Compliance Test
echo "Running structure compliance test..."
if node --test test/structure-compliance.test.js; then
    echo "  ✓ Structure is compliant"
else
    echo "  ✖ Structure compliance failed! Forcing re-init..."
    npm run sync:pathways
    if ! node --test test/structure-compliance.test.js; then
        echo "  ✖ Critical: Structure still non-compliant after re-init."
    fi
fi

# 3. Check for additional overlays from environment variable
# Format: OVERLAYS="ecosystem:layer:git_url,ecosystem2:layer2:git_url2"
if [ -n "$ADDITIONAL_OVERLAYS" ]; then
    IFS=',' read -ra ADDR <<< "$ADDITIONAL_OVERLAYS"
    for i in "${ADDR[@]}"; do
        IFS=':' read -ra PARTS <<< "$i"
        ECOSYSTEM="${PARTS[0]}"
        LAYER="${PARTS[1]}"
        GIT_URL="${PARTS[2]}"
        
        TARGET_DIR="content/$ECOSYSTEM/layers/$LAYER"
        echo "Processing overlay: $ECOSYSTEM:$LAYER from $GIT_URL..."
        
        if [ ! -d "$TARGET_DIR" ]; then
            mkdir -p "$TARGET_DIR"
            git clone --depth 1 "$GIT_URL" "$TARGET_DIR"
            echo "  ✓ Cloned to $TARGET_DIR"
        else
            echo "  → $TARGET_DIR already exists, skipping clone"
        fi
    done
fi

echo "=== Setup Complete ==="

