#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== MDTutor Content Initialization ===${NC}"

# 1. Ask for confirmation if content exists
if [ -d "content/RPL" ]; then
    echo -e "${YELLOW}Warnung: Das Content-Verzeichnis existiert bereits.${NC}"
    read -p "Soll ich den vorhandenen Content löschen und neu laden? (y/N) " confirm
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        echo "Abgebrochen."
        exit 0
    fi
    # Preserve ecosystem.yaml if it exists
    echo "Lösche alten Content (bewahre ecosystem.yaml)..."
    find content/RPL -mindepth 1 ! -name 'ecosystem.yaml' -exec rm -rf {} + 2>/dev/null || true
    rm -rf content/TAG test/snapshots/*
fi

# 2. Create basic structure for config
mkdir -p content/RPL/config
mkdir -p test/snapshots

# 2.1 Ensure ecosystem.yaml exists
if [ ! -f "content/RPL/ecosystem.yaml" ]; then
    echo "Stelle Standard ecosystem.yaml für RPL wieder her..."
    cat > content/RPL/ecosystem.yaml <<EOF
name: Raspberry Pi Learning
namespace: RPL
parser_type: rpl-markdown
semantic_prefix: RPL
EOF
fi

# 3. Ensure default sync.yaml exists
if [ ! -f "content/RPL/config/sync.yaml" ]; then
    echo "Stelle Standard sync.yaml für RPL wieder her..."
    cat > content/RPL/config/sync.yaml <<EOF
layers:
  tag:
    priority: 100
    git_base: "https://github.com/tag-makerspace"
  official:
    priority: 10
    git_base: "https://github.com/raspberrypilearning"
    api_base: "https://learning-admin.raspberrypi.org/api/v1"

sync:
  pathways:
    official:
      - scratch-intro
      - more-scratch
      - further-scratch
EOF
fi

# 4. Fetch RPL data using the official sync tool
# This script:
#   - Fetches pathway metadata from RPL API
#   - Creates content/RPL/layers/official/pathways/*.yaml
#   - Clones all project repositories into content/RPL/layers/official/projects/
#   - Fetches project API snapshots into test/snapshots/
echo "Lade RPL Referenz-Daten (Lernpfade und Tutorials)..."
npm run sync:pathways

# 5. Run compliance test
echo -e "\n${GREEN}Prüfe Struktur-Compliance...${NC}"
if node --test test/structure-compliance.test.js; then
    echo -e "${GREEN}✓ Struktur ist korrekt.${NC}"
else
    echo -e "${RED}✖ Struktur-Compliance fehlgeschlagen!${NC}"
    exit 1
fi

echo -e "\n${GREEN}=== Initialisierung erfolgreich abgeschlossen ===${NC}"
