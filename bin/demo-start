#!/bin/bash
set -e

# MDTutor Demo Start Script
# -------------------------

ENV_FILE="docker.env"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== MDTutor Demo Launcher ===${NC}\n"

# 1. Check if docker.env exists
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}Fehler: $ENV_FILE wurde nicht gefunden!${NC}"
    echo -e "Bitte erstelle eine Datei namens ${YELLOW}$ENV_FILE${NC} im Hauptverzeichnis."
    echo -e "Du kannst die folgende Vorlage nutzen:\n"
    
    echo "DOMAIN=mdtutor.test"
    echo "SSO_JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || echo "gera_secret_12345")"
    echo "ACHIEVEMENTS_MASTER_KEY=$(cat packages/backend-ruby/config/master.key 2>/dev/null || echo "KEY_FEHLT")"
    echo "SSO_MASTER_KEY=$(cat packages/sso-server/config/master.key 2>/dev/null || echo "KEY_FEHLT")"
    
    echo -e "\n${YELLOW}Hinweis:${NC} Die Master Keys findest du normalerweise in:"
    echo " - packages/backend-ruby/config/master.key"
    echo " - packages/sso-server/config/master.key"
    exit 1
fi

# 2. Load environment and check for missing values
source "$ENV_FILE"

MISSING=0
if [ -z "$ACHIEVEMENTS_MASTER_KEY" ] || [ "$ACHIEVEMENTS_MASTER_KEY" == "KEY_FEHLT" ]; then
    echo -e "${RED}⚠ ACHIEVEMENTS_MASTER_KEY ist nicht gesetzt!${NC}"
    MISSING=1
fi
if [ -z "$SSO_MASTER_KEY" ] || [ "$SSO_MASTER_KEY" == "KEY_FEHLT" ]; then
    echo -e "${RED}⚠ SSO_MASTER_KEY ist nicht gesetzt!${NC}"
    MISSING=1
fi

if [ $MISSING -eq 1 ]; then
    echo -e "\nBitte ergänze die fehlenden Keys in ${YELLOW}$ENV_FILE${NC}."
    exit 1
fi

# 3. Instruction for Local DNS
echo -e "${GREEN}Prüfung abgeschlossen.${NC}"

PORT_SUFFIX=""
if [ -n "$TRAEFIK_PORT" ] && [ "$TRAEFIK_PORT" != "80" ]; then
    PORT_SUFFIX=":$TRAEFIK_PORT"
fi

MAIN_DOMAIN="${DOMAIN:-mdtutor.test}"
SSO_DOMAIN="sso.${MAIN_DOMAIN}"

echo -e "Die Demo wird unter folgenden Domains erreichbar sein:"
echo -e " - http://${MAIN_DOMAIN}${PORT_SUFFIX}"
echo -e " - http://${SSO_DOMAIN}${PORT_SUFFIX}"
echo ""

# Active DNS Check
echo -e "Prüfe DNS-Auflösung..."
DNS_OK=1

check_dns() {
    local domain=$1
    if ! ping -c 1 -W 1 "$domain" >/dev/null 2>&1; then
        if ! host "$domain" >/dev/null 2>&1 && ! getent hosts "$domain" >/dev/null 2>&1; then
            echo -e "${RED}✖ $domain konnte nicht aufgelöst werden!${NC}"
            return 1
        fi
    fi
    echo -e "${GREEN}✓ $domain ist erreichbar${NC}"
    return 0
}

check_dns "$MAIN_DOMAIN" || DNS_OK=0
check_dns "$SSO_DOMAIN" || DNS_OK=0

if [ $DNS_OK -eq 0 ]; then
    echo -e "\n${YELLOW}Hinweis:${NC} Die Domains scheinen nicht auf diesen Rechner zu zeigen."
    echo -e "Stelle sicher, dass folgende Zeile in deiner ${YELLOW}/etc/hosts${NC} steht:"
    echo -e "${GREEN}127.0.0.1  $MAIN_DOMAIN $SSO_DOMAIN${NC}"
    echo ""
    read -p "Trotzdem fortfahren? (y/N) " confirm
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 4. Check for Docker
if ! docker info >/dev/null 2>&1; then
    echo -e "${RED}Fehler: Docker scheint nicht zu laufen oder du hast keine Berechtigung.${NC}"
    exit 1
fi

# 5. Run Docker Compose
echo -e "${GREEN}Starte Docker-Container...${NC}"
COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

COMMIT_HASH=$COMMIT_HASH docker-compose --env-file "$ENV_FILE" up -d --build

echo -e "\n${GREEN}Demo läuft!${NC}"
echo -e "Nutze ${YELLOW}docker-compose logs -f${NC} für Live-Logs."

